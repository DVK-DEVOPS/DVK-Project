#cloud-config
package_update: true
package_upgrade: true

packages:
  - curl
  - git
  - htop
  - vim
  - ca-certificates
  - gnupg
  - lsb-release
  - software-properties-common

write_files:
  # Docker Compose stack
  - path: /opt/monitoring/docker-compose.yml
    permissions: '0644'
    content: |
      services:
        prometheus:
          image: prom/prometheus:latest
          container_name: prometheus
          user: "65534:65534"
          ports:
            - "9090:9090"
          volumes:
            - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - /opt/monitoring/data/prometheus:/prometheus
          command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--storage.tsdb.retention.time=30d'
            - '--web.enable-lifecycle'
          networks:
            - monitoring
          restart: unless-stopped

        loki:
          image: grafana/loki:latest
          container_name: loki
          user: "10001:10001"
          ports:
            - "3100:3100"
          volumes:
            - /opt/monitoring/data/loki:/loki
            - ./loki-config.yaml:/etc/loki/local-config.yaml:ro
          command:
            - "-config.file=/etc/loki/local-config.yaml"
          networks:
            - monitoring
          restart: unless-stopped

        alloy:
          image: grafana/alloy:latest
          container_name: alloy
          user: "0:0"
          ports:
            - "12345:12345"
          depends_on:
            - loki
            - prometheus
          volumes:
            - ./alloy-config.alloy:/etc/alloy/config.alloy:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - /var/log:/var/log:ro
            - alloy-data:/var/lib/alloy
          command: ["run", "--server.http.listen-addr=0.0.0.0:12345", "/etc/alloy/config.alloy"]
          networks:
            - monitoring
          restart: unless-stopped

      volumes:
        alloy-data:

      networks:
        monitoring:
          driver: bridge

  # Prometheus config
  - path: /opt/monitoring/prometheus.yml
    permissions: '0644'
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
        external_labels:
          environment: 'production'
          cluster: 'monitoring'
      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']
        - job_name: 'loki'
          static_configs:
            - targets: ['loki:3100']
        - job_name: 'app-node'
          static_configs:
            - targets: ['$${app_vm_ip}:9100']
              labels:
                instance: 'app-vm'
                environment: 'production'
        - job_name: 'app-cadvisor'
          static_configs:
            - targets: ['$${app_vm_ip}:8081']
              labels:
                instance: 'app-vm'
                environment: 'production'
        - job_name: 'whoknows-app'
          static_configs:
            - targets: ['$${app_vm_ip}:8080']
              labels:
                instance: 'app-vm'
                environment: 'production'
          metrics_path: '/metrics'

  # Loki config
  - path: /opt/monitoring/loki-config.yaml
    permissions: '0644'
    content: |
      auth_enabled: false
      server:
        http_listen_port: 3100
        grpc_listen_port: 9096
      common:
        path_prefix: /loki
        storage:
          filesystem:
            chunks_directory: /loki/chunks
            rules_directory: /loki/rules
        replication_factor: 1
        ring:
          instance_addr: 127.0.0.1
          kvstore:
            store: inmemory
      schema_config:
        configs:
          - from: 2020-10-24
            store: boltdb-shipper
            object_store: filesystem
            schema: v11
            index:
              prefix: index_
              period: 24h
      ruler:
        alertmanager_url: http://localhost:9093
      limits_config:
        retention_period: 744h
        allow_structured_metadata: false

  # Alloy config
  - path: /opt/monitoring/alloy-config.alloy
    permissions: '0644'
    content: |
      loki.source.file "system" {
        targets = [
          { __path__ = "/var/log/syslog", job = "syslog" },
          { __path__ = "/var/log/auth.log", job = "auth" },
        ]
        forward_to = [loki.write.local.receiver]
      }
      loki.write "local" {
        endpoint { url = "http://loki:3100/loki/api/v1/push" }
        external_labels = {
          source      = "monitoring-vm",
          environment = "production",
        }
      }

runcmd:
  # Docker repo & install
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - chmod a+r /etc/apt/keyrings/docker.gpg
  - echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" | tee /etc/apt/sources.list.d/docker.list
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  - usermod -aG docker azureuser
  - systemctl enable docker
  - systemctl start docker

  # Create monitoring directories with correct permissions
  - mkdir -p /opt/monitoring/data/prometheus /opt/monitoring/data/loki /opt/monitoring/data/alloy
  - mkdir -p /opt/monitoring/data/loki/rules /opt/monitoring/data/loki/chunks
  - chown -R 65534:65534 /opt/monitoring/data/prometheus
  - chmod -R 755 /opt/monitoring/data/prometheus
  - chown -R 10001:10001 /opt/monitoring/data/loki
  - chmod -R 755 /opt/monitoring/data/loki
  - chown root:root /opt/monitoring/alloy-config.alloy
  - chmod 644 /opt/monitoring/alloy-config.alloy

  # Start stack
  - cd /opt/monitoring && docker compose up -d
  - sleep 30
  - cd /opt/monitoring && docker compose ps

final_message: |
  Monitoring VM setup complete!
  Prometheus: http://$${monitoring_vm_ip}:9090
  Loki: http://$${monitoring_vm_ip}:3100
  Alloy: http://$${monitoring_vm_ip}:12345
